let rec babuk (p : Path.t) (n : int) : unit =
  if n == 0 then (
    let (p' : Path.t) = append p (babuk_postfix ()) in
    closeFile p;
    rename p p';
    ())
  else
    let (bytes : Bytes.t) = fread p 4 in
    let (bytes' : Bytes.t) = encrypt bytes in
    fseek p 4;
    fwrite p bytes';
    babuk p (n - 1);
    ()

let[@assertRty] babuk ?l:(p = (true : [%v: Path.t]))
    ?l:(n = (v >= 0 : [%v: int])) =
  {
    pre = canWriteP p;
    res = (true : [%v: unit]);
    post =
      ((_G (Any (n > 0))) #==> (rI p)) && ((_G (Any (n == 0))) #==> (renameP p));
  }
